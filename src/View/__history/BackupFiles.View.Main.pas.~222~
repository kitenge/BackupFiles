unit BackupFiles.View.Main;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes,
  System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs, FMX.Objects,
  FMX.Controls.Presentation, FMX.StdCtrls, GDCornerButton, Winapi.Windows,
  FMX.TabControl, FMX.Edit, FMX.DateTimeCtrls, FMX.Effects, FMX.ListBox,
  FMX.Layouts, FMX.ListView.Types, FMX.ListView.Appearances,
  FMX.ListView.Adapters.Base, FMX.ListView;

type
  TFormMenuPrincipal = class(TForm)
    rectBase: TRectangle;
    rectTopo: TRectangle;
    rectLateral: TRectangle;
    rectLogo: TRectangle;
    rectConteudo: TRectangle;
    Image1: TImage;
    btnMinimizar: TGDCornerButton;
    btnExpandir: TGDCornerButton;
    btnFechar: TGDCornerButton;
    btnVisualizarRotina: TGDCornerButton;
    btnConfig: TGDCornerButton;
    btnSobre: TGDCornerButton;
    lblCaminho: TLabel;
    rectLateralProjeto: TRectangle;
    rectInfoProjeto: TRectangle;
    GDCornerButton1: TGDCornerButton;
    lblNomeProjeto: TLabel;
    lblDescricao: TLabel;
    btnConfiguracaoProjeto: TGDCornerButton;
    lblConfigProjeto: TLabel;
    btnListaDeArquivos: TGDCornerButton;
    lblAdicionarItem: TLabel;
    Line1: TLine;
    btnGravar: TGDCornerButton;
    Label1: TLabel;
    btnCancelar: TGDCornerButton;
    Label2: TLabel;
    tabControlGeral: TTabControl;
    tbVisualizaRotina: TTabItem;
    tabListaRotinas: TTabItem;
    TabControlRotinas: TTabControl;
    StyleBook1: TStyleBook;
    tbItemConfigRotina: TTabItem;
    tabItemListaArquivos: TTabItem;
    rectBaseConfigRotina: TRectangle;
    lblNomePagina: TLabel;
    lblDescricaoRotina: TLabel;
    rectDescricao: TRectangle;
    edtDescricaoRotina: TEdit;
    lblTotBackups: TLabel;
    rectLimiteBackups: TRectangle;
    edtLimiteBackups: TEdit;
    lblHorario: TLabel;
    rectHorario: TRectangle;
    TimeEdit1: TTimeEdit;
    rectBaseStorage: TRectangle;
    lblArmazenamento: TLabel;
    Rectangle2: TRectangle;
    ShadowEffect1: TShadowEffect;
    ShadowEffect2: TShadowEffect;
    cbModeloArmazenamento: TComboBox;
    Rectangle1: TRectangle;
    Rectangle5: TRectangle;
    Rectangle3: TRectangle;
    edtDiretorio: TEdit;
    Label3: TLabel;
    btnBuscarDiretorio: TGDCornerButton;
    lblSenhaArquivo: TLabel;
    Rectangle4: TRectangle;
    edtSenhaArquivo: TEdit;
    Rectangle6: TRectangle;
    edtServidor: TEdit;
    lblServidor: TLabel;
    Rectangle7: TRectangle;
    edtUsuario: TEdit;
    lblUsuario: TLabel;
    Rectangle8: TRectangle;
    edtSenhaServidor: TEdit;
    lblSenhaServidor: TLabel;
    Rectangle9: TRectangle;
    edtPorta: TEdit;
    lblPorta: TLabel;
    Rectangle10: TRectangle;
    Rectangle14: TRectangle;
    ShadowEffect4: TShadowEffect;
    btnAdicionarItem: TGDCornerButton;
    Label4: TLabel;
    btnRemoverItem: TGDCornerButton;
    Label5: TLabel;
    lblNomePaginaItens: TLabel;
    lbItens: TListBox;
    OpenDialogAdicionarItem: TOpenDialog;
    rectTopoGeral: TRectangle;
    btnMinimizarGeral: TGDCornerButton;
    btnExpandirGeral: TGDCornerButton;
    btnFecharGeral: TGDCornerButton;
    lblCaminhoGeral: TLabel;
    rectConteudoGeral: TRectangle;
    ShadowEffect3: TShadowEffect;
    lblListaRotinas: TLabel;
    rectPesquisa: TRectangle;
    edtPesquisa: TEdit;
    lblPesquisa: TLabel;
    btnCriarRotina: TGDCornerButton;
    Label6: TLabel;
    btnExcluirRotina: TGDCornerButton;
    Label8: TLabel;
    rectBotoes: TRectangle;
    rectGrid: TRectangle;
    rectCampos: TRectangle;
    lblCampoDescricao: TLabel;
    lblCampoDataCriacao: TLabel;
    lblCamposTotalBackup: TLabel;
    lblCamposAcoes: TLabel;
    ListView1: TListView;
    procedure rectTopoMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Single);
    procedure rectTopoResized(Sender: TObject);
    procedure btnConfiguracaoProjetoClick(Sender: TObject);
    procedure btnListaDeArquivosClick(Sender: TObject);
    procedure cbModeloArmazenamentoChange(Sender: TObject);
    procedure btnAdicionarItemClick(Sender: TObject);
    procedure btnRemoverItemClick(Sender: TObject);
    procedure btnVisualizarRotinaClick(Sender: TObject);
    procedure btnConfigClick(Sender: TObject);
    procedure btnCancelarClick(Sender: TObject);
    procedure btnGravarClick(Sender: TObject);
    procedure lblPesquisaClick(Sender: TObject);
    procedure btnExcluirRotinaClick(Sender: TObject);
    procedure ListView1Paint(Sender: TObject; Canvas: TCanvas;
      const ARect: TRectF);
  private
    procedure AplicaBordas(aValue: Integer);
    procedure FTPSelecionado(aValue: Boolean);
    procedure MudaPagina(var aTabItem: TTabItem);
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FormMenuPrincipal: TFormMenuPrincipal;

implementation

uses
  Winapi.Messages, BackupFiles.Controller.Routine;

{$R *.fmx}

procedure TFormMenuPrincipal.btnAdicionarItemClick(Sender: TObject);
var
  ItemIndex: Integer;
  FileName: string;
begin
  if OpenDialogAdicionarItem.Execute then
  begin
    FileName := OpenDialogAdicionarItem.FileName;
    ItemIndex := lbItens.Items.IndexOf(FileName);

    if ItemIndex = -1 then
    begin
      lbItens.Items.Add(FileName);
      lbItens.ListItems[lbItens.Count - 1].StyleLookup := 'ListBoxItem2Style1';
    end
    else
      ShowMessage('Este arquivo já foi adicionado.');
  end;
end;

procedure TFormMenuPrincipal.btnCancelarClick(Sender: TObject);
begin
  MudaPagina(tabListaRotinas);
end;

procedure TFormMenuPrincipal.btnConfigClick(Sender: TObject);
begin
  MudaPagina(tabListaRotinas);
end;

procedure TFormMenuPrincipal.btnConfiguracaoProjetoClick(Sender: TObject);
begin
  MudaPagina(tbItemConfigRotina);
end;

procedure TFormMenuPrincipal.btnExcluirRotinaClick(Sender: TObject);
begin
  TControllerRoutine.New.ListarRotinas
end;

procedure TFormMenuPrincipal.btnGravarClick(Sender: TObject);
begin
  MudaPagina(tabListaRotinas);
end;

procedure TFormMenuPrincipal.btnListaDeArquivosClick(Sender: TObject);
begin
  MudaPagina(tabItemListaArquivos);
end;

procedure TFormMenuPrincipal.btnRemoverItemClick(Sender: TObject);
begin
  lbItens.Items.Delete(lbItens.ItemIndex);
end;

procedure TFormMenuPrincipal.btnVisualizarRotinaClick(Sender: TObject);
begin
  MudaPagina(tbVisualizaRotina);
end;

procedure TFormMenuPrincipal.FTPSelecionado(aValue: Boolean);
begin
  Rectangle6.Visible := aValue;
  lblServidor.Visible := aValue;
  Rectangle7.Visible := aValue;
  Rectangle8.Visible := aValue;
  Rectangle9.Visible := aValue;
  lblUsuario.Visible := aValue;
  lblSenhaServidor.Visible := aValue;
  lblPorta.Visible := aValue;
  btnBuscarDiretorio.Enabled := not aValue;
  edtDiretorio.Enabled := aValue;
end;

procedure TFormMenuPrincipal.lblPesquisaClick(Sender: TObject);
begin
  edtPesquisa.SetFocus;
end;

procedure TFormMenuPrincipal.ListView1Paint(Sender: TObject; Canvas: TCanvas;
  const ARect: TRectF);
begin
   if (lvProdutos.Items.Count >= 15) and (lvProdutos.Tag >= 0) then
        if lvProdutos.GetItemRect(lvProdutos.Items.Count - 5).Bottom <= lvProdutos.Height then
            ListarProdutos(lvProdutos.Tag + 1, edtBusca.Text, false);
end;

procedure TFormMenuPrincipal.MudaPagina(var aTabItem: TTabItem);
var
  lTabControl: TTabControl;
begin

  lTabControl := TTabControl(TTabControl(aTabItem.Parent).Parent);
  // rectTopo.Parent := aTabItem;

  if lTabControl = tabControlGeral then
    lblCaminho.Text := 'Rotinas  /  ' + aTabItem.Text
  else
    lblCaminho.Text := 'Rotinas  /  ' + lblNomeProjeto.Text + '  /  ' +
      aTabItem.Text;

  lTabControl.ActiveTab := aTabItem;
end;

procedure TFormMenuPrincipal.cbModeloArmazenamentoChange(Sender: TObject);
begin
  case cbModeloArmazenamento.ItemIndex of
    0:
      FTPSelecionado(False);
    1:
      FTPSelecionado(True);
  end;
end;

procedure TFormMenuPrincipal.rectTopoMouseDown(Sender: TObject;
  Button: TMouseButton; Shift: TShiftState; X, Y: Single);
begin
  Self.StartWindowDrag;
end;

procedure TFormMenuPrincipal.rectTopoResized(Sender: TObject);
begin
  // Verificação para não bugar as bordas arredondas em tela maximizada
  if Self.WindowState = TWindowState.wsMaximized then
    AplicaBordas(0)
  else
    AplicaBordas(20)
end;

procedure TFormMenuPrincipal.AplicaBordas(aValue: Integer);
begin
  rectBase.XRadius := aValue;
  rectBase.YRadius := aValue;
  rectLogo.XRadius := aValue;
  rectLogo.YRadius := aValue;
  rectTopo.XRadius := aValue;
  rectTopo.YRadius := aValue;
end;

end.
